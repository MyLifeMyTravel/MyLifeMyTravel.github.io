<!DOCTYPE html>
<html>
<head>
    

    

    
<!-- Baidu Tongji -->
<script>var _hmt = _hmt || []</script>
<script async src="//hm.baidu.com/hm.js?da8b560613f099edf2026f081f8a793c"></script>
<!-- End Baidu Tongji -->




    <meta charset="utf-8">
    
    
    
    <title>Android 自定义View之圆形进度条总结 | 厉圣杰的博客 | 啦啦啦，德玛西亚</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="theme-color" content="#3F51B5">
    
    
    <meta name="keywords" content="Android,自定义View,圆形进度条,水波纹进度条">
    <meta name="description" content="版权声明：本文为博主原创文章，未经博主允许不得转载。微博：厉圣杰微信公众号：牙锅子源码：CircleProgress文中如有纰漏，欢迎大家留言指出。

最近撸了一个圆形进度条的开源项目，算是第一次完完整整的使用自定义 View 。在此对项目开发思路做个小结，欢迎大家 Star 和 Fork
该项目总共实现了三种圆形进度条效果

CircleProgress：圆形进度条，可以实现仿 QQ 健康计步">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 自定义View之圆形进度条总结">
<meta property="og:url" content="http://www.littlejie.com/2017/03/02/Android-自定义View之圆形进度条总结/index.html">
<meta property="og:site_name" content="厉圣杰的博客">
<meta property="og:description" content="版权声明：本文为博主原创文章，未经博主允许不得转载。微博：厉圣杰微信公众号：牙锅子源码：CircleProgress文中如有纰漏，欢迎大家留言指出。

最近撸了一个圆形进度条的开源项目，算是第一次完完整整的使用自定义 View 。在此对项目开发思路做个小结，欢迎大家 Star 和 Fork
该项目总共实现了三种圆形进度条效果

CircleProgress：圆形进度条，可以实现仿 QQ 健康计步">
<meta property="og:image" content="http://odsdowehg.bkt.clouddn.com/a.gif">
<meta property="og:image" content="http://odsdowehg.bkt.clouddn.com/b.gif">
<meta property="og:image" content="http://odsdowehg.bkt.clouddn.com/WechatIMG2.jpeg">
<meta property="og:image" content="http://odsdowehg.bkt.clouddn.com/device-2017-03-02-071101.png">
<meta property="og:image" content="http://odsdowehg.bkt.clouddn.com/1344993412_1866.png">
<meta property="og:image" content="http://odsdowehg.bkt.clouddn.com/WechatIMG3.jpeg">
<meta property="og:image" content="http://odsdowehg.bkt.clouddn.com/WechatIMG1.jpeg">
<meta property="og:image" content="http://odsdowehg.bkt.clouddn.com/WechatIMG1-1.jpeg">
<meta property="og:image" content="http://odsdowehg.bkt.clouddn.com/WechatIMG1-2.jpeg">
<meta property="og:updated_time" content="2017-03-02T14:40:05.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android 自定义View之圆形进度条总结">
<meta name="twitter:description" content="版权声明：本文为博主原创文章，未经博主允许不得转载。微博：厉圣杰微信公众号：牙锅子源码：CircleProgress文中如有纰漏，欢迎大家留言指出。

最近撸了一个圆形进度条的开源项目，算是第一次完完整整的使用自定义 View 。在此对项目开发思路做个小结，欢迎大家 Star 和 Fork
该项目总共实现了三种圆形进度条效果

CircleProgress：圆形进度条，可以实现仿 QQ 健康计步">
<meta name="twitter:image" content="http://odsdowehg.bkt.clouddn.com/a.gif">
    
        <link rel="alternative" href="/atom.xml" title="厉圣杰的博客" type="application/atom+xml">
    
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="stylesheet" href="/css/style.css?v=1.4.7">
    <script>window.lazyScripts=[]</script>
</head>

<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="hide" >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/avatar.jpeg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">厉圣杰</h5>
          <a href="mailto:1025263614@qq.com" title="1025263614@qq.com" class="mail">1025263614@qq.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/MyLifeMyTravel" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="http://weibo.com/2952381050/profile?topnav=1&wvr=6" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                微博
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">Android 自定义View之圆形进度条总结</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">

    <div class="container fade-scale">
        <h1 class="title">Android 自定义View之圆形进度条总结</h1>
        <h5 class="subtitle">
            
                <time datetime="2017-03-02T14:39:18.000Z" itemprop="datePublished" class="page-time">
  2017-03-02
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/">Android</a></li></ul>

            
        </h5>
    </div>

    

</header>


<div class="container body-wrap">
    
    <aside class="post-widget">
        <nav class="post-toc-wrap" id="post-toc">
            <!-- <h4>TOC</h4> -->
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#圆形进度条"><span class="post-toc-number">1.</span> <span class="post-toc-text">圆形进度条</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#补充：同一个属性如何支持颜色和颜色数组"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">补充：同一个属性如何支持颜色和颜色数组</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#带刻度进度条"><span class="post-toc-number">2.</span> <span class="post-toc-text">带刻度进度条</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#水波纹效果的进度条"><span class="post-toc-number">3.</span> <span class="post-toc-text">水波纹效果的进度条</span></a></li></ol>
        </nav>
    </aside>
    
<article id="post-Android-自定义View之圆形进度条总结"
  class="post-article article-type-post fade" itemprop="blogPost">

    <div class="post-card">
        <h1 class="post-card-title">Android 自定义View之圆形进度条总结</h1>
        <div class="post-meta">
            <time class="post-time" title="2017年03月02日 22:39" datetime="2017-03-02T14:39:18.000Z"  itemprop="datePublished">2017-03-02</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/">Android</a></li></ul>



            
<span id="busuanzi_container_page_pv" title="文章总阅读量" style='display:none'>
    <i class="icon icon-eye icon-pr"></i><span id="busuanzi_value_page_pv"></span>
</span>


            

        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            <blockquote>
<p>版权声明：本文为博主原创文章，未经博主允许不得转载。<br>微博：<a href="http://weibo.com/2952381050/profile?rightmod=1&amp;wvr=6&amp;mod=personinfo" target="_blank" rel="external">厉圣杰</a><br>微信公众号：牙锅子<br>源码：<a href="https://github.com/MyLifeMyTravel/CircleProgress" target="_blank" rel="external">CircleProgress</a><br><strong>文中如有纰漏，欢迎大家留言指出。</strong></p>
</blockquote>
<p>最近撸了一个圆形进度条的开源项目，算是第一次完完整整的使用自定义 View 。在此对项目开发思路做个小结，欢迎大家 <strong>Star 和 Fork</strong></p>
<p>该项目总共实现了三种圆形进度条效果</p>
<ol>
<li>CircleProgress：圆形进度条，可以实现仿 QQ 健康计步器的效果，支持配置进度条背景色、宽度、起始角度，支持进度条渐变</li>
<li>DialProgress：类似 CircleProgress，但是支持刻度</li>
<li>WaveProgress：实现了水波纹效果的圆形进度条，不支持渐变和起始角度配置，如需此功能可参考 CircleProgress 自行实现。</li>
</ol>
<p>先上效果图，有图才好说。<br>CircleProgress 效果图<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://odsdowehg.bkt.clouddn.com/a.gif" alt="a" title="">
                </div>
                <div class="image-caption">a</div>
            </figure></p>
<p>DialProgress 和 WaveProgress 效果图<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://odsdowehg.bkt.clouddn.com/b.gif" alt="b" title="">
                </div>
                <div class="image-caption">b</div>
            </figure></p>
<p>恩，那么接下来，就来讲讲怎么实现以上自定义进度条的效果。</p>
<h2 id="圆形进度条"><a href="#圆形进度条" class="headerlink" title="圆形进度条"></a>圆形进度条</h2><p>圆形进度条是第一个实现的进度条效果，用了我大半天的时间，实现起来并不复杂。</p>
<p>其思路主要可以分为以下几步：</p>
<ol>
<li>View 的测量</li>
<li>计算绘制 View 所需参数</li>
<li>圆弧的绘制及渐变的实现</li>
<li>文字的绘制</li>
<li>动画效果的实现</li>
</ol>
<p>首先，我们要测量出所绘制 View 的大小，即重写 <code>onMeasure()</code> 方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">   <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">   setMeasuredDimension(MiscUtil.measure(widthMeasureSpec, mDefaultSize),</div><div class="line">           MiscUtil.measure(heightMeasureSpec, mDefaultSize));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于其他两个进度条类都需要实现 View 的测量，这里对代码进行了封装：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* 测量 View</div><div class="line">*</div><div class="line">* <span class="doctag">@param</span> measureSpec</div><div class="line">* <span class="doctag">@param</span> defaultSize View 的默认大小</div><div class="line">* <span class="doctag">@return</span> 测量出来的 View 大小</div><div class="line">*/</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">measure</span><span class="params">(<span class="keyword">int</span> measureSpec, <span class="keyword">int</span> defaultSize)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> result = defaultSize;</div><div class="line">   <span class="keyword">int</span> specMode = View.MeasureSpec.getMode(measureSpec);</div><div class="line">   <span class="keyword">int</span> specSize = View.MeasureSpec.getSize(measureSpec);</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (specMode == View.MeasureSpec.EXACTLY) &#123;</div><div class="line">       result = specSize;</div><div class="line">   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (specMode == View.MeasureSpec.AT_MOST) &#123;</div><div class="line">       result = Math.min(result, specSize);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关于 View 测量可以看下这篇博客 <a href="http://blog.csdn.net/a739697044/article/details/30234161" target="_blank" rel="external">Android 自定义View 中的onMeasure的用法</a></p>
<p>接下来，在 <code>onSizeChanged()</code> 中计算绘制圆及文字所需的参数，考虑到屏幕旋转的情况，故未直接在 <code>onMeasure()</code> 方法中直接计算。这里以下面草图来讲解绘制计算过程中的注意事项，图丑，勿怪~<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://odsdowehg.bkt.clouddn.com/WechatIMG2.jpeg" alt="WechatIMG2" title="">
                </div>
                <div class="image-caption">WechatIMG2</div>
            </figure></p>
<p>图中，外面蓝色矩形为 View，里面黑色矩形为圆的外接矩形，蓝色矩形和黑色矩形中间空白的地方为 View 的内边距(padding)。两个蓝色的圆其实是一个圆，代表圆的粗细，这是因为 Android 在绘制圆或者圆弧的时候是圆的边宽的中心与外接矩形相交，所以在计算的时候要考虑到内边距(padding) 和 圆与外接矩形的相交。</p>
<p>默认不考虑圆弧的宽度，绘制出来的效果如下：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://odsdowehg.bkt.clouddn.com/device-2017-03-02-071101.png" alt="device-2017-03-02-071101" title="">
                </div>
                <div class="image-caption">device-2017-03-02-071101</div>
            </figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onSizeChanged</span><span class="params">(<span class="keyword">int</span> w, <span class="keyword">int</span> h, <span class="keyword">int</span> oldw, <span class="keyword">int</span> oldh)</span> </span>&#123;</div><div class="line">   <span class="keyword">super</span>.onSizeChanged(w, h, oldw, oldh);</div><div class="line">   Log.d(TAG, <span class="string">"onSizeChanged: w = "</span> + w + <span class="string">"; h = "</span> + h + <span class="string">"; oldw = "</span> + oldw + <span class="string">"; oldh = "</span> + oldh);</div><div class="line">   <span class="comment">//求圆弧和背景圆弧的最大宽度</span></div><div class="line">   <span class="keyword">float</span> maxArcWidth = Math.max(mArcWidth, mBgArcWidth);</div><div class="line">   <span class="comment">//求最小值作为实际值</span></div><div class="line">   <span class="keyword">int</span> minSize = Math.min(w - getPaddingLeft() - getPaddingRight() - <span class="number">2</span> * (<span class="keyword">int</span>) maxArcWidth,</div><div class="line">           h - getPaddingTop() - getPaddingBottom() - <span class="number">2</span> * (<span class="keyword">int</span>) maxArcWidth);</div><div class="line">   <span class="comment">//减去圆弧的宽度，否则会造成部分圆弧绘制在外围</span></div><div class="line">   mRadius = minSize / <span class="number">2</span>;</div><div class="line">   <span class="comment">//获取圆的相关参数</span></div><div class="line">   mCenterPoint.x = w / <span class="number">2</span>;</div><div class="line">   mCenterPoint.y = h / <span class="number">2</span>;</div><div class="line">   <span class="comment">//绘制圆弧的边界</span></div><div class="line">   mRectF.left = mCenterPoint.x - mRadius - maxArcWidth / <span class="number">2</span>;</div><div class="line">   mRectF.top = mCenterPoint.y - mRadius - maxArcWidth / <span class="number">2</span>;</div><div class="line">   mRectF.right = mCenterPoint.x + mRadius + maxArcWidth / <span class="number">2</span>;</div><div class="line">   mRectF.bottom = mCenterPoint.y + mRadius + maxArcWidth / <span class="number">2</span>;</div><div class="line">   <span class="comment">//计算文字绘制时的 baseline</span></div><div class="line">   <span class="comment">//由于文字的baseline、descent、ascent等属性只与textSize和typeface有关，所以此时可以直接计算</span></div><div class="line">   <span class="comment">//若value、hint、unit由同一个画笔绘制或者需要动态设置文字的大小，则需要在每次更新后再次计算</span></div><div class="line">   mValueOffset = mCenterPoint.y - (mValuePaint.descent() + mValuePaint.ascent()) / <span class="number">2</span>;</div><div class="line">   mHintOffset = mCenterPoint.y * <span class="number">2</span> / <span class="number">3</span> - (mHintPaint.descent() + mHintPaint.ascent()) / <span class="number">2</span>;</div><div class="line">   mUnitOffset = mCenterPoint.y * <span class="number">4</span> / <span class="number">3</span> - (mUnitPaint.descent() + mUnitPaint.ascent()) / <span class="number">2</span>;</div><div class="line">   updateArcPaint();</div><div class="line">   Log.d(TAG, <span class="string">"onSizeChanged: 控件大小 = "</span> + <span class="string">"("</span> + w + <span class="string">", "</span> + h + <span class="string">")"</span></div><div class="line">           + <span class="string">"圆心坐标 = "</span> + mCenterPoint.toString()</div><div class="line">           + <span class="string">";圆半径 = "</span> + mRadius</div><div class="line">           + <span class="string">";圆的外接矩形 = "</span> + mRectF.toString());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关于 Android 中文字绘制可以参考以下两篇文章：</p>
<ol>
<li><a href="http://www.jianshu.com/p/1728b725b4a6" target="_blank" rel="external">Android 自定义View学习(三)——Paint 绘制文字属性</a></li>
<li><a href="http://stackoverflow.com/questions/7549182/android-paint-measuretext-vs-gettextbounds" target="_blank" rel="external">measureText() vs .getTextBounds()</a></li>
</ol>
<p>以上，已经基本完成了 View 绘制所需全部参数的计算。接下来就是绘制圆弧及文字了。</p>
<p>绘制圆弧需要用到 Canvas 的 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// oval 为 RectF 类型，即圆弧显示区域</span></div><div class="line"><span class="comment">// startAngle 和 sweepAngle  均为 float 类型，分别表示圆弧起始角度和圆弧度数。3点钟方向为0度，顺时针递增</span></div><div class="line"><span class="comment">// 如果 startAngle &lt; 0 或者 &gt; 360,则相当于 startAngle % 360</span></div><div class="line"><span class="comment">// useCenter:如果为 true 时，在绘制圆弧时将圆心包括在内，通常用来绘制扇形</span></div><div class="line"><span class="comment">// 绘制圆弧的画笔</span></div><div class="line">drawArc(RectF oval, <span class="keyword">float</span> startAngle, <span class="keyword">float</span> sweepAngle, <span class="keyword">boolean</span> useCenter, Paint paint);</div></pre></td></tr></table></figure>
<p>为了方便计算，绘制圆弧的时候使用了 Canvas 的 <code>rotate()</code> 方法，对坐标系进行了旋转</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawArc</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">   <span class="comment">// 绘制背景圆弧</span></div><div class="line">   <span class="comment">// 从进度圆弧结束的地方开始重新绘制，优化性能</span></div><div class="line">   canvas.save();</div><div class="line">   <span class="keyword">float</span> currentAngle = mSweepAngle * mPercent;</div><div class="line">   canvas.rotate(mStartAngle, mCenterPoint.x, mCenterPoint.y);</div><div class="line">   <span class="comment">// +2 是因为绘制的时候出现了圆弧起点有尾巴的问题</span></div><div class="line">   canvas.drawArc(mRectF, currentAngle, mSweepAngle - currentAngle + <span class="number">2</span>, <span class="keyword">false</span>, mBgArcPaint);</div><div class="line">   canvas.drawArc(mRectF, <span class="number">2</span>, currentAngle, <span class="keyword">false</span>, mArcPaint);</div><div class="line">   canvas.restore();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>恩，圆环已经绘制完成，那么接下来就是实现圆环的渐变，这里使用 <code>SweepGradient</code> 类。<code>SweepGradient</code> 可以实现从中心放射性渐变的效果，如下图：<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://odsdowehg.bkt.clouddn.com/1344993412_1866.png" alt="1344993412_1866" title="">
                </div>
                <div class="image-caption">1344993412_1866</div>
            </figure></p>
<p><code>SweepGradient</code> 类有两个构造方法，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@param</span> cx 渲染中心点x坐标</div><div class="line"> * <span class="doctag">@param</span> cy 渲染中心点y坐标</div><div class="line"> * <span class="doctag">@param</span> colors 围绕中心渲染的颜色数组，至少要有两种颜色值</div><div class="line"> * <span class="doctag">@param</span> positions 相对位置的颜色数组,可为null,  若为null,可为null,颜色沿渐变线均匀分布。一般不需要设置该参数</div><div class="line"> /</div><div class="line">public SweepGradient(float cx, float cy, int[] colors, float[] positions)</div><div class="line"></div><div class="line">/**</div><div class="line"> * <span class="doctag">@param</span> cx 渲染中心点x坐标</div><div class="line"> * <span class="doctag">@param</span> cy 渲染中心点y坐标</div><div class="line"> * <span class="doctag">@param</span> color0 起始渲染颜色</div><div class="line"> * <span class="doctag">@param</span> color1 结束渲染颜色</div><div class="line"> /</div><div class="line">public SweepGradient(float cx, float cy, int color0, int color1)</div></pre></td></tr></table></figure>
<p>这里我们选择第一个构造方法。<strong>由于设置渐变需要每次都创建一个新的 <code>SweepGradient</code> 对象，所以最好不要放到 <code>onDraw</code> 方法中去更新，最好在初始化的时候就设置好，避免频繁创建导致内存抖动。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateArcPaint</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="comment">// 设置渐变</span></div><div class="line">   <span class="keyword">int</span>[] mGradientColors = &#123;Color.GREEN, Color.YELLOW, Color.RED&#125;;</div><div class="line">   mSweepGradient = <span class="keyword">new</span> SweepGradient(mCenterPoint.x, mCenterPoint.y, mGradientColors, <span class="keyword">null</span>);</div><div class="line">   mArcPaint.setShader(mSweepGradient);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里还有一个值得注意的地方，草图如下<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://odsdowehg.bkt.clouddn.com/WechatIMG3.jpeg" alt="WechatIMG3" title="">
                </div>
                <div class="image-caption">WechatIMG3</div>
            </figure><br>假设，渐变颜色如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span>[] mGradientColors = &#123;Color.GREEN, Color.YELLOW, Color.RED, Color.BLUE&#125;;</div></pre></td></tr></table></figure>
<p><strong>因为 <code>SweepGradient</code> 渐变是 360 度的，所以如果你绘制的圆弧只有 270度，则蓝色部分（图中黑色阴影部分）的渐变就会不可见。</strong></p>
<p>接下来，就是文字的绘制了。文字绘制在上述提到的文章中已经进行了详细的讲解，这里就不再赘述。代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawText</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">   canvas.drawText(String.format(mPrecisionFormat, mValue), mCenterPoint.x, mValueOffset, mValuePaint);</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (mHint != <span class="keyword">null</span>) &#123;</div><div class="line">       canvas.drawText(mHint.toString(), mCenterPoint.x, mHintOffset, mHintPaint);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (mUnit != <span class="keyword">null</span>) &#123;</div><div class="line">       canvas.drawText(mUnit.toString(), mCenterPoint.x, mUnitOffset, mUnitPaint);</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后，我们来实现进度条的动画效果。这里我们使用 Android 的属性动画来实现进度更新。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startAnimator</span><span class="params">(<span class="keyword">float</span> start, <span class="keyword">float</span> end, <span class="keyword">long</span> animTime)</span> </span>&#123;</div><div class="line">   mAnimator = ValueAnimator.ofFloat(start, end);</div><div class="line">   mAnimator.setDuration(animTime);</div><div class="line">   mAnimator.addUpdateListener(<span class="keyword">new</span> ValueAnimator.AnimatorUpdateListener() &#123;</div><div class="line">       <span class="meta">@Override</span></div><div class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAnimationUpdate</span><span class="params">(ValueAnimator animation)</span> </span>&#123;</div><div class="line">           mPercent = (<span class="keyword">float</span>) animation.getAnimatedValue();</div><div class="line">           mValue = mPercent * mMaxValue;</div><div class="line">           <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</div><div class="line">               Log.d(TAG, <span class="string">"onAnimationUpdate: percent = "</span> + mPercent</div><div class="line">                       + <span class="string">";currentAngle = "</span> + (mSweepAngle * mPercent)</div><div class="line">                       + <span class="string">";value = "</span> + mValue);</div><div class="line">           &#125;</div><div class="line">           invalidate();</div><div class="line">       &#125;</div><div class="line">   &#125;);</div><div class="line">   mAnimator.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里有两个注意点：</p>
<ol>
<li>不要在 <code>ValueAnimator.AnimatorUpdateListener</code> 中输出 Log，特别是动画调用频繁的情况下，因为输出 Log 频繁会生成大量 String 对象造成内存抖动，当然也可以使用 <code>StringBuilder</code> 来优化。</li>
<li>关于 <code>invalidate()</code> 和 <code>postInvalidate()</code> 两者最本质的前者只能在 UI 线程中使用，而后者可以在非 UI 线程中使用，其实 <code>postInvalidate()</code> 内部也是使用 Handler 实现的。</li>
</ol>
<p>关于 Android 属性动画可以参考：</p>
<ol>
<li><a href="http://blog.csdn.net/lmj623565791/article/details/38067475/" target="_blank" rel="external">Android 属性动画（Property Animation） 完全解析 （上）</a></li>
<li><a href="http://blog.csdn.net/lmj623565791/article/details/38092093" target="_blank" rel="external">Android 属性动画（Property Animation） 完全解析 （下）</a></li>
</ol>
<h3 id="补充：同一个属性如何支持颜色和颜色数组"><a href="#补充：同一个属性如何支持颜色和颜色数组" class="headerlink" title="补充：同一个属性如何支持颜色和颜色数组"></a>补充：同一个属性如何支持颜色和颜色数组</h3><p>考虑到圆弧设置单色和渐变的区别，即单色只需要提供一种色值，而渐变至少需要提供两种色值。可以有以下几种解决方案：</p>
<ol>
<li>定义两个属性，渐变的优先级高于单色的。</li>
<li>定义一个 format 为 <code>string</code> 属性，以 <code>#FFFFFF|#000000</code> 形式提供色值</li>
<li>定义一个 format 为 <code>color|reference</code> 的属性，其中 <code>reference</code> 属性指代渐变色的数组。</li>
</ol>
<p>这里选用第三种方案，实现如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 圆形进度条 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">"CircleProgressBar"</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!-- 圆弧颜色， --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">"arcColors"</span> <span class="attr">format</span>=<span class="string">"color|reference"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- colors.xml --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"green"</span>&gt;</span>#00FF00<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"blue"</span>&gt;</span>#EE9A00<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">"red"</span>&gt;</span>#EE0000<span class="tag">&lt;/<span class="name">color</span>&gt;</span></div><div class="line"><span class="comment">&lt;!-- 渐变颜色数组 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">integer-array</span> <span class="attr">name</span>=<span class="string">"gradient_arc_color"</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">item</span>&gt;</span>@color/green<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">item</span>&gt;</span>@color/blue<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">item</span>&gt;</span>@color/red<span class="tag">&lt;/<span class="name">item</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">integer-array</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 布局文件中使用 --&gt;</span></div><div class="line"><span class="comment">&lt;!-- 使用渐变 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">com.littlejie.circleprogress.DialProgress</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/dial_progress_bar"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"300dp"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"300dp"</span></div><div class="line">    <span class="attr">app:arcColors</span>=<span class="string">"@array/gradient_arc_color"</span> /&gt;</div><div class="line"><span class="comment">&lt;!-- 使用单色 --&gt;</span>    </div><div class="line"><span class="tag">&lt;<span class="name">com.littlejie.circleprogress.DialProgress</span></span></div><div class="line">    <span class="attr">android:id</span>=<span class="string">"@+id/dial_progress_bar"</span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"300dp"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"300dp"</span></div><div class="line">    <span class="attr">app:arcColors</span>=<span class="string">"@color/green"</span> /&gt;</div></pre></td></tr></table></figure>
<p>代码中读取 xml 中配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> gradientArcColors = typedArray.getResourceId(R.styleable.CircleProgressBar_arcColors, <span class="number">0</span>);</div><div class="line">   <span class="keyword">if</span> (gradientArcColors != <span class="number">0</span>) &#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           <span class="keyword">int</span>[] gradientColors = getResources().getIntArray(gradientArcColors);</div><div class="line">           <span class="keyword">if</span> (gradientColors.length == <span class="number">0</span>) &#123;<span class="comment">//如果渐变色为数组为0，则尝试以单色读取色值</span></div><div class="line">               <span class="keyword">int</span> color = getResources().getColor(gradientArcColors);</div><div class="line">               mGradientColors = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</div><div class="line">               mGradientColors[<span class="number">0</span>] = color;</div><div class="line">               mGradientColors[<span class="number">1</span>] = color;</div><div class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (gradientColors.length == <span class="number">1</span>) &#123;<span class="comment">//如果渐变数组只有一种颜色，默认设为两种相同颜色</span></div><div class="line">               mGradientColors = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</div><div class="line">               mGradientColors[<span class="number">0</span>] = gradientColors[<span class="number">0</span>];</div><div class="line">               mGradientColors[<span class="number">1</span>] = gradientColors[<span class="number">0</span>];</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               mGradientColors = gradientColors;</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">catch</span> (Resources.NotFoundException e) &#123;</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> Resources.NotFoundException(<span class="string">"the give resource not found."</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h2 id="带刻度进度条"><a href="#带刻度进度条" class="headerlink" title="带刻度进度条"></a>带刻度进度条</h2><p>前面，详细讲了 CircleProgress 的绘制思路，接下来讲 DialProgress。</p>
<p>实话说，DialProgress 与 CircleProgress 的实现极其相似，因为两者之间其实就差了一个刻度，但考虑到扩展以及类职责的单一，所以将两者分开。</p>
<p>这里主要讲一下刻度的绘制。刻度绘制主要使用 Canvas 类的 <code>save()</code>、<code>rotate()</code>和<code>restore()</code> 方法，当然你也可以使用 <code>translate()</code> 方法对坐标系进行平移，方便计算。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 用来保存Canvas的状态。save之后，可以调用Canvas的平移、放缩、旋转、错切、裁剪等操作。</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">()</span></span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 旋转一定的角度绘制图像</div><div class="line"> * @param degrees 旋转角度</div><div class="line"> * @param x 旋转中心点x轴坐标</div><div class="line"> * @param y 旋转中心点y轴坐标</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rotate</span><span class="params">(<span class="keyword">float</span> degrees, <span class="keyword">float</span> x, <span class="keyword">float</span> y)</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 在当前的坐标上平移(x,y)个像素单位</div><div class="line"> * 若dx &lt;0 ，沿x轴向上平移； dx &gt;0  沿x轴向下平移</div><div class="line"> * 若dy &lt;0 ，沿y轴向上平移； dy &gt;0  沿y轴向下平移</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">translate</span><span class="params">(<span class="keyword">float</span> dx, <span class="keyword">float</span> dy)</span></div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 用来恢复Canvas之前保存的状态。防止save后对Canvas执行的操作对后续的绘制有影响。</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">restore</span><span class="params">()</span></div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawDial</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">   <span class="keyword">int</span> total = (<span class="keyword">int</span>) (mSweepAngle / mDialIntervalDegree);</div><div class="line">   canvas.save();</div><div class="line">   canvas.rotate(mStartAngle, mCenterPoint.x, mCenterPoint.y);</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= total; i++) &#123;</div><div class="line">       canvas.drawLine(mCenterPoint.x + mRadius, mCenterPoint.y, mCenterPoint.x + mRadius + mArcWidth, mCenterPoint.y, mDialPaint);</div><div class="line">       canvas.rotate(mDialIntervalDegree, mCenterPoint.x, mCenterPoint.y);</div><div class="line">   &#125;</div><div class="line">   canvas.restore();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>关于 Canvas 的画布操作可以参考这篇文章：<a href="http://blog.csdn.net/u013831257/article/details/50599912" target="_blank" rel="external">安卓自定义View进阶-Canvas之画布操作</a></p>
<h2 id="水波纹效果的进度条"><a href="#水波纹效果的进度条" class="headerlink" title="水波纹效果的进度条"></a>水波纹效果的进度条</h2><p>水波纹效果的进度条实现需要用到贝塞尔曲线，主要难点在于 <strong>绘制区域的计算</strong> 和 <strong>波浪效果</strong> 的实现，其余的逻辑跟上述两种进度条相似。</p>
<p>这里使用了 Path 类，该类在 Android 2D 绘图中是非常重要的，Path 不仅能够绘制简单图形，也可以绘制这些比较复杂的图形。也可以对多个路径进行布尔操作，类似设置 Paint 的 <code>setXfermode()</code> ，具体使用可以参考这篇博客：<a href="http://blog.csdn.net/u013831257/article/details/50784565" target="_blank" rel="external">安卓自定义View进阶-Path基本操作</a>。这里就不再赘述，有机会自己也会对 Android 自定义 View 的知识进行总结，不过，感觉应该了了无期。</p>
<p>继续上示意图，请叫我灵魂画手~<br><figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://odsdowehg.bkt.clouddn.com/WechatIMG1.jpeg" alt="WechatIMG1" title="">
                </div>
                <div class="image-caption">WechatIMG1</div>
            </figure></p>
<p>图中黑色的圆为我们要绘制的进度条圆，黑色的曲线为初始状态的的波浪，该波浪使用贝塞尔曲线绘制，其中奇数的点为贝塞尔曲线的起始点，偶数的点为贝塞尔曲线的控制点。例如：1——&gt;2——&gt;3就为一条贝塞尔曲线，1 是起点，2 是控制点，3 是终点。从图中可以看到波浪在园内圆外各一个(1—&gt;5 和 5-&gt;9)，通过对波浪在 x 轴上做平移，即图中蓝色实线，来实现波浪的动态效果，所以一个波浪的完整动画效果需要有两个波浪来实现。同理，通过控制 y 轴的偏移量，即图中蓝色虚线，可以实现波浪随进度的上涨下降。</p>
<p>贝塞尔曲线上起始点和控制点的计算如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * 计算贝塞尔曲线上的起始点和控制点</div><div class="line"> * <span class="doctag">@param</span> waveWidth 一个完整波浪的宽度</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> Point[] getPoint(<span class="keyword">float</span> waveWidth) &#123;</div><div class="line">   Point[] points = <span class="keyword">new</span> Point[mAllPointCount];</div><div class="line">   <span class="comment">//第1个点特殊处理，即数组的中心</span></div><div class="line">   points[mHalfPointCount] = <span class="keyword">new</span> Point((<span class="keyword">int</span>) (mCenterPoint.x - mRadius), mCenterPoint.y);</div><div class="line">   <span class="comment">//屏幕内的贝塞尔曲线点</span></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = mHalfPointCount + <span class="number">1</span>; i &lt; mAllPointCount; i += <span class="number">4</span>) &#123;</div><div class="line">       <span class="keyword">float</span> width = points[mHalfPointCount].x + waveWidth * (i / <span class="number">4</span> - mWaveNum);</div><div class="line">       points[i] = <span class="keyword">new</span> Point((<span class="keyword">int</span>) (waveWidth / <span class="number">4</span> + width), (<span class="keyword">int</span>) (mCenterPoint.y - mWaveHeight));</div><div class="line">       points[i + <span class="number">1</span>] = <span class="keyword">new</span> Point((<span class="keyword">int</span>) (waveWidth / <span class="number">2</span> + width), mCenterPoint.y);</div><div class="line">       points[i + <span class="number">2</span>] = <span class="keyword">new</span> Point((<span class="keyword">int</span>) (waveWidth * <span class="number">3</span> / <span class="number">4</span> + width), (<span class="keyword">int</span>) (mCenterPoint.y + mWaveHeight));</div><div class="line">       points[i + <span class="number">3</span>] = <span class="keyword">new</span> Point((<span class="keyword">int</span>) (waveWidth + width), mCenterPoint.y);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">//屏幕外的贝塞尔曲线点</span></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mHalfPointCount; i++) &#123;</div><div class="line">       <span class="keyword">int</span> reverse = mAllPointCount - i - <span class="number">1</span>;</div><div class="line">       points[i] = <span class="keyword">new</span> Point(points[mHalfPointCount].x - points[reverse].x,</div><div class="line">               points[mHalfPointCount].y * <span class="number">2</span> - points[reverse].y);</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">return</span> points;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上，我们已经获取到绘制贝塞尔曲线所需的路径点。接下来，我们就需要来计算出绘制区域，即使用 Path 类。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://odsdowehg.bkt.clouddn.com/WechatIMG1-1.jpeg" alt="WechatIMG1" title="">
                </div>
                <div class="image-caption">WechatIMG1</div>
            </figure>
<p>紫色区域为贝塞尔曲线需要绘制的整体区域。</p>
<figure class="image-bubble">
                <div class="img-lightbox">
                    <div class="overlay"></div>
                    <img src="http://odsdowehg.bkt.clouddn.com/WechatIMG1-2.jpeg" alt="WechatIMG1" title="">
                </div>
                <div class="image-caption">WechatIMG1</div>
            </figure>
<p>红色区域为上图紫色区域与圆的交集，也就是波浪要显示的区域</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//该方法必须在 Android 19以上的版本才能使用(Path.op())</span></div><div class="line"><span class="meta">@TargetApi</span>(Build.VERSION_CODES.KITKAT)</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">drawWave</span><span class="params">(Canvas canvas, Paint paint, Point[] points, <span class="keyword">float</span> waveOffset)</span> </span>&#123;</div><div class="line">   mWaveLimitPath.reset();</div><div class="line">   mWavePath.reset();</div><div class="line">   <span class="comment">//lockWave 用于判断波浪是否随进度条上涨下降</span></div><div class="line">   <span class="keyword">float</span> height = lockWave ? <span class="number">0</span> : mRadius - <span class="number">2</span> * mRadius * mPercent;</div><div class="line">   <span class="comment">//moveTo和lineTo绘制出水波区域矩形</span></div><div class="line">   mWavePath.moveTo(points[<span class="number">0</span>].x + waveOffset, points[<span class="number">0</span>].y + height);</div><div class="line"></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; mAllPointCount; i += <span class="number">2</span>) &#123;</div><div class="line">       mWavePath.quadTo(points[i].x + waveOffset, points[i].y + height,</div><div class="line">               points[i + <span class="number">1</span>].x + waveOffset, points[i + <span class="number">1</span>].y + height);</div><div class="line">   &#125;</div><div class="line">   mWavePath.lineTo(points[mAllPointCount - <span class="number">1</span>].x, points[mAllPointCount - <span class="number">1</span>].y + height);</div><div class="line">   <span class="comment">//不管如何移动，波浪与圆路径的交集底部永远固定，否则会造成上移的时候底部为空的情况</span></div><div class="line">   mWavePath.lineTo(points[mAllPointCount - <span class="number">1</span>].x, mCenterPoint.y + mRadius);</div><div class="line">   mWavePath.lineTo(points[<span class="number">0</span>].x, mCenterPoint.y + mRadius);</div><div class="line">   mWavePath.close();</div><div class="line">   mWaveLimitPath.addCircle(mCenterPoint.x, mCenterPoint.y, mRadius, Path.Direction.CW);</div><div class="line">   <span class="comment">//取该圆与波浪路径的交集，形成波浪在圆内的效果</span></div><div class="line">   mWaveLimitPath.op(mWavePath, Path.Op.INTERSECT);</div><div class="line">   canvas.drawPath(mWaveLimitPath, paint);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上，就实现了水波动态的效果，当然，你也可以通过配置，来设定水波是否随进度上涨下降。为了实现更好的效果，可以设置一个浅色的水波并支持设置水波的走向(<strong>R2L 和 L2R</strong>)，通过设置浅色波浪和深色波浪动画的时间，从而实现长江后浪推前浪的效果，恩，效果很自然的~自己脑补从右至左波浪的实现和贝塞尔点的计算。</p>
<p>对获取坐标点的代码进行优化：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* 从左往右或者从右往左获取贝塞尔点</div><div class="line">*</div><div class="line">* <span class="doctag">@return</span></div><div class="line">*/</div><div class="line"><span class="keyword">private</span> Point[] getPoint(<span class="keyword">boolean</span> isR2L, <span class="keyword">float</span> waveWidth) &#123;</div><div class="line">   Point[] points = <span class="keyword">new</span> Point[mAllPointCount];</div><div class="line">   <span class="comment">//第1个点特殊处理，即数组的中点</span></div><div class="line">   points[mHalfPointCount] = <span class="keyword">new</span> Point((<span class="keyword">int</span>) (mCenterPoint.x + (isR2L ? mRadius : -mRadius)), mCenterPoint.y);</div><div class="line">   <span class="comment">//屏幕内的贝塞尔曲线点</span></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = mHalfPointCount + <span class="number">1</span>; i &lt; mAllPointCount; i += <span class="number">4</span>) &#123;</div><div class="line">       <span class="keyword">float</span> width = points[mHalfPointCount].x + waveWidth * (i / <span class="number">4</span> - mWaveNum);</div><div class="line">       points[i] = <span class="keyword">new</span> Point((<span class="keyword">int</span>) (waveWidth / <span class="number">4</span> + width), (<span class="keyword">int</span>) (mCenterPoint.y - mWaveHeight));</div><div class="line">       points[i + <span class="number">1</span>] = <span class="keyword">new</span> Point((<span class="keyword">int</span>) (waveWidth / <span class="number">2</span> + width), mCenterPoint.y);</div><div class="line">       points[i + <span class="number">2</span>] = <span class="keyword">new</span> Point((<span class="keyword">int</span>) (waveWidth * <span class="number">3</span> / <span class="number">4</span> + width), (<span class="keyword">int</span>) (mCenterPoint.y + mWaveHeight));</div><div class="line">       points[i + <span class="number">3</span>] = <span class="keyword">new</span> Point((<span class="keyword">int</span>) (waveWidth + width), mCenterPoint.y);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">//屏幕外的贝塞尔曲线点</span></div><div class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mHalfPointCount; i++) &#123;</div><div class="line">       <span class="keyword">int</span> reverse = mAllPointCount - i - <span class="number">1</span>;</div><div class="line">       points[i] = <span class="keyword">new</span> Point((isR2L ? <span class="number">2</span> : <span class="number">1</span>) * points[mHalfPointCount].x - points[reverse].x,</div><div class="line">               points[mHalfPointCount].y * <span class="number">2</span> - points[reverse].y);</div><div class="line">   &#125;</div><div class="line">   <span class="comment">//对从右向左的贝塞尔点数组反序，方便后续处理</span></div><div class="line">   <span class="keyword">return</span> isR2L ? MiscUtil.reverse(points) : points;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>至此，自定义圆形进度条相关的思路已全部讲述完成。代码已全部上传至 Git ，欢迎大家 <strong>Star 和 Fork</strong>，传送门：<a href="https://github.com/MyLifeMyTravel/CircleProgress" target="_blank" rel="external">CircleProgress</a>。</p>
<p>如有不清楚或者错误的地方，欢迎指出~</p>

        </div>

        <blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2017-03-02T14:40:05.000Z" itemprop="dateUpdated">2017年3月2日 22:40</time>
</span><br>


        这里写留言或版权声明：<a href="/2017/03/02/Android-自定义View之圆形进度条总结/" target="_blank" rel="external">http://www.littlejie.com/2017/03/02/Android-自定义View之圆形进度条总结/</a>
    </div>
    <footer>
        <a href="http://www.littlejie.com">
            <img src="/img/avatar.jpeg" alt="厉圣杰">
            厉圣杰
        </a>
    </footer>
</blockquote>

        
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>



        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/圆形进度条/">圆形进度条</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/水波纹进度条/">水波纹进度条</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/自定义View/">自定义View</a></li></ul>


            
<div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://www.littlejie.com/2017/03/02/Android-自定义View之圆形进度条总结/&title=《Android 自定义View之圆形进度条总结》 — 厉圣杰的博客&pic=http://www.littlejie.com/img/avatar.jpeg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.littlejie.com/2017/03/02/Android-自定义View之圆形进度条总结/&title=《Android 自定义View之圆形进度条总结》 — 厉圣杰的博客&source=希望有一天我能够很坦然地说："让我来告诉你，在我眼中，这是一个怎样的世界。"" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://www.littlejie.com/2017/03/02/Android-自定义View之圆形进度条总结/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Android 自定义View之圆形进度条总结》 — 厉圣杰的博客&url=http://www.littlejie.com/2017/03/02/Android-自定义View之圆形进度条总结/&via=http://www.littlejie.com" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://www.littlejie.com/2017/03/02/Android-自定义View之圆形进度条总结/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>



        </div>
    </div>

    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="waves-block waves-effect next">
      <a href="/2017/02/22/自定义仿-QQ-健康计步器进度条/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">自定义仿 QQ 健康计步器进度条</h4>
      </a>
    </div>
  
</nav>



    







</article>

<div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        谢谢老板~
        <i class="icon icon-quote-right"></i>
    </h3>
    <ul class="reward-items">
        
        <li>
            <img src="/img/wechat.jpeg" title="微信打赏二维码" alt="微信打赏二维码">
            <p>微信</p>
        </li>
        

        
        <li>
            <img src="/img/alipay.jpeg" title="支付宝打赏二维码" alt="支付宝打赏二维码">
            <p>支付宝</p>
        </li>
        
    </ul>
</div>



</div>

        <footer class="footer">
    <div class="top">
        
<p>
    <span id="busuanzi_container_site_uv" style='display:none'>
        站点总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style='display:none'>
        站点总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


        <p>
            <span><a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-lg icon-rss"></i></a></span>
            <span>博客内容遵循 <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">知识共享 署名 - 非商业性 - 相同方式共享 4.0协议</a></span>
        </p>
    </div>
    <div class="bottom">
        <p>
            <span>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></span>
            <span>厉圣杰的博客 &copy; 2015 - 2017</span>
        </p>
    </div>
</footer>

    </main>
    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://www.littlejie.com/2017/03/02/Android-自定义View之圆形进度条总结/&title=《Android 自定义View之圆形进度条总结》 — 厉圣杰的博客&pic=http://www.littlejie.com/img/avatar.jpeg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://www.littlejie.com/2017/03/02/Android-自定义View之圆形进度条总结/&title=《Android 自定义View之圆形进度条总结》 — 厉圣杰的博客&source=希望有一天我能够很坦然地说："让我来告诉你，在我眼中，这是一个怎样的世界。"" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://www.littlejie.com/2017/03/02/Android-自定义View之圆形进度条总结/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Android 自定义View之圆形进度条总结》 — 厉圣杰的博客&url=http://www.littlejie.com/2017/03/02/Android-自定义View之圆形进度条总结/&via=http://www.littlejie.com" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://www.littlejie.com/2017/03/02/Android-自定义View之圆形进度条总结/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACxUlEQVR42u3aUY4iMQwFwLn/pXcPwDa8Zyczs1LlC0HTnQpSbOx8fcXjz8t4/fTpndfXT/dpn3ts4OHh4a2n/nq79w94//4TPrlbMp8PS4CHh4d3jZc8pt2+2wCQLEo+Zzw8PLzfz8vz2xkeDw8P7//lFens28nlweZbAwMeHh5ezEuKEfk2nUwrWbJkgY7VWvDw8PC63btOhX/29ZX+Hh4eHt66q942n9oixSbJjmaLh4eHd4GXb7g5dRNmNsWLxyvx8PDwjvLyhv17Rl5imOXAH36fp+XDw8PDu8DblFk3RwGSBU0aXVGpAg8PD+8or20sJWGjTY5bXv4pHh4e3g1eW3KdFRHaYwr7Fh0eHh7ebd6sAJEjN8l0fk3RAMPDw8Nb8PLJbQoH7eRm5eB/fBcPDw/vAi/Zyos//PG3ksVqC8EfUmo8PDy8Q7xZm39WYtgXIJIQEp2MwMPDwzvKS27UptFF+js6+/B4JR4eHt41XtvOT7bsdnJtaaM4TYaHh4d3gZcXcDcHCNr752Hg8WfAw8PD+0ZenkznSfnskMGsfBzVWvDw8PAO8drkdZZMJ5v+fkHx8PDwbvOS0kC+3be9+1PJ9GNKjYeHh3eBl2/WySPPHh2ok2k8PDy8y7ykBdUWfPPAk482VODh4eHd4CVTnx17mjW38pCwSqzx8PDwLvDapDYvT2wKFrO2GR4eHt7385Lb5anzZoHywnERGPDw8PAWvFkRob3DLAx8xeMf1+Ph4eEd5c0KqckU8zAwy36jhBsPDw/vAq/dcHP2rAHWNuG+Tg08PDy8krcJBptC8OwpebEYDw8P7zYv7xy1jf9ZWXYW2T5UqfHw8PB+lJds3G3AmCXr0ZlcPDw8vF/Aa0uo+YTyZY2OwOLh4eFd4yXb+iyZ3qfgx05G4OHh4R3itV/Lt+bNtl4HgH1/Dw8PD+/z+AukCj+k1TTwsgAAAABJRU5ErkJggg==" alt="微信分享二维码">
</div>




    <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: true };



</script>

<script src="/js/main.min.js?v=1.4.7"></script>


<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.4.7" async></script>






<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>


</body>
</html>
